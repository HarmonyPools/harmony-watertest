<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harmony Pools — Water Test</title>
  <style>
    :root{ --sky:#0ea5e9; --text:#0f172a; --muted:#64748b; --bg:#f1f5f9; }
    #hp-watertest *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(#f0f9ff,#fff); color:var(--text); }
    #hp-watertest{ padding:16px; }
    .hp-container{ max-width:1100px; margin:0 auto; }
    .hp-row{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:900px){ .hp-row{ grid-template-columns:1fr 1fr; } }
    .hp-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .hp-h1{ font-size:28px; font-weight:600; margin:0 0 12px; }
    .hp-h2{ font-size:18px; font-weight:600; margin:0 0 8px; }
    .hp-label{ font-size:13px; color:#334155; display:block; margin-bottom:6px; }
    .hp-input,.hp-select{ width:100%; border:1px solid #cbd5e1; border-radius:12px; padding:10px 12px; font-size:14px; }
    .hp-tip{ font-size:12px; color:#64748b; margin-top:6px; }
    .hp-btn{ background:var(--sky); color:#fff; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .hp-btn:hover{ filter:brightness(.95); }
    .hp-ghost{ background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
    .hp-table{ width:100%; border-collapse:collapse; font-size:14px; }
    .hp-table th{ text-align:left; color:#64748b; font-weight:600; }
    .hp-table td,.hp-table th{ padding:6px 8px; border-top:1px solid #f1f5f9; }
    .hp-chip{ display:inline-flex; align-items:center; background:#f1f5f9; color:#0f172a; border-radius:999px; padding:2px 8px; font-size:12px; }
    .hp-note{ font-size:12px; color:#64748b; }
    .hp-sub{ margin:6px 0 0 12px; }
  </style>
</head>
<body>
  <div id="hp-watertest"></div>

  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect } = React;

    // =========================
    //  CONFIG: paste your CSV URL here (from “Publish to web”)
    //  Example format:
    //  https://docs.google.com/spreadsheets/d/XXXX/export?format=csv
    // =========================
    const REMOTE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1HgxbWQ441jPd-mXIQV9Hu1uQTUQztXe6wEUS870HGAdArrs9eSDUoJJBX4waWAarA7fy-m66IPIm/pub?output=csv';

    // ---------- helpers ----------
    const round2=(n)=>Math.round(n*100)/100;
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    const roundQuarterGal=(gal)=> gal<=0 ? 0 : Math.max(0.25, Math.round(gal*4)/4);

    // Harmony Pools policy
    const targetFC = (sanitizer)=> sanitizer==='swg' ? 5 : 3;

    // Acid dose (approx, fl oz 31.45% per 10k per ΔpH)
    function acidFlOzForDeltaPH(delta, gal, TA){
      if (delta<=0) return 0;
      const t={0.2:6,0.4:12,0.6:18,0.8:24,1.0:32};
      const keys=Object.keys(t).map(parseFloat).sort((a,b)=>a-b);
      let need=t[keys[keys.length-1]];
      for(let i=0;i<keys.length;i++){
        if(delta===keys[i]){need=t[keys[i]];break;}
        if(delta<keys[i]){
          const k1=keys[i-1]||0,k2=keys[i],v1=k1?t[k1]:0,v2=t[k2];
          const a=(delta-k1)/(k2-k1); need=v1+a*(v2-v1); break;
        }
      }
      let fl=need*(gal/10000);
      if(TA&&TA>120) fl*=.85; if(TA&&TA<60) fl*=1.15;
      return fl;
    }

    // Raise pH with soda ash — ~12 oz / 10k raises ≈0.2 pH
    function lbsSodaAshForDeltaPH(delta, gal){
      if (delta<=0) return 0;
      const ozPer10kPer0_2 = 12;
      const ounces = (delta/0.2) * ozPer10kPer0_2 * (gal/10000);
      return ounces/16;
    }

    // Your FC rule: 1 gal (or 1 lb dichlor) per 10k = +3 ppm
    const galLCForFC = (dFC, gal)=> dFC<=0 ? 0 : (dFC/3)*(gal/10000);
    function lbsDichlorForFC(dFC, gal){
      if(dFC<=0) return {lbs:0,cyaGain:0};
      const lbs=(dFC/3)*(gal/10000);
      const cyaGain = lbs*6*(10000/gal);
      return {lbs,cyaGain};
    }

    const lbsBicarbForTA = (dTA, gal)=> dTA<=0 ? 0 : (dTA/10)*1.4*(gal/10000);
    const lbsStabilizerForCYA = (dCYA, gal)=> dCYA<=0 ? 0 : (dCYA/10)*0.8125*(gal/10000);

    // Salt math (charts): 83.5 lb / 10k gal raises 1000 ppm
    function lbsSaltForDelta(dSalt, gal){ if(dSalt<=0) return 0; return dSalt * gal * 0.00000835; }
    function ppmFromSaltLbs(lbs, gal){ if(lbs<=0) return 0; return lbs / (gal * 0.00000835); }

    function containersNeeded(amount,size){
      if(!size||size<=0) return {units:0,usePct:0};
      const u=Math.ceil(amount/size);
      const p=amount/(u*size)*100;
      return {units:u,usePct:Math.min(100,Math.round(p))};
    }

    // Default products (urls blank by default)
    var DEFAULT_PRODUCTS=[
      { name:'Muriatic Acid gallon', type:'acid', size:1, unit:'gal', pct:31.45, url:'', pack:undefined },
      { name:'Muriatic Acid case', type:'acid', size:1, unit:'gal', pct:31.45, url:'', pack:4 },
      { name:'Liquid Chlorine case', type:'liquidChlorine', size:1, unit:'gal', pct:12.5, url:'', pack:4 },
      { name:'Soda Ash 10 lb', type:'sodaAsh', size:10, unit:'lb', url:'' },
      { name:'Bicarbonate 10 lb', type:'bicarb', size:10, unit:'lb', url:'' },
      { name:'Stabilizer 4 lb', type:'stabilizer', size:4, unit:'lb', url:'' },
      { name:'Pool Salt 40 lb', type:'salt', size:40, unit:'lb', url:'' },
      { name:'Dichlor 25 lb', type:'dichlor', size:25, unit:'lb', pct:56, url:'' },
      { name:'Phosphate Remover 1 qt', type:'phosphateRemover', size:1, unit:'qt', url:'' },
    ];

    // Try to fetch products from a published CSV (optional)
    async function loadProductsFromCSV(url){
      const res = await fetch(url, {mode:'cors'});
      if(!res.ok) throw new Error('CSV fetch failed');
      const text = await res.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      const header = lines.shift(); if(!header) throw new Error('Empty CSV');
      const cols = header.split(',').map(s=>s.trim());

      // Flexible matching of headings you used before
      const pick = (rx)=> cols.findIndex(c=> rx.test(c));
      const idx = {
        name: pick(/^(product\s*name)$/i),
        type: pick(/^(dose\s*type|type)$/i),
        size: pick(/^(size\s*amount|size)$/i),
        unit: pick(/^(size\s*unit|unit)$/i),
        pct:  pick(/^(strength|%|percent)$/i),
        url:  pick(/^(url|link)$/i),
        notes: pick(/^notes?$/i),
        pack: pick(/^(pack|case|qty)$/i),
      };

      const out=[];
      for(const row of lines){
        const cells=row.split(',');
        const get=(k)=> idx[k]>=0 ? (cells[idx[k]]||'').trim() : '';
        const name=get('name'), type=get('type'), unit=get('unit');
        const size=parseFloat(get('size')||'0');
        if(name && type && unit && size){
          const p={
            name, type,
            size, unit,
            pct: get('pct') ? parseFloat(get('pct')) : undefined,
            url: get('url')||'',
            notes: get('notes')||undefined,
            pack: get('pack') ? parseInt(get('pack')) : undefined
          };
          out.push(p);
        }
      }
      if(out.length===0) throw new Error('No valid rows');
      return out;
    }

    function pickProduct(products, type){
      const opts=products.filter(p=>p.type===type);
      if(!opts.length) return undefined;
      if(type==='liquidChlorine'){ const c=opts.find(o=>o.pack&&o.pack>1); return c||opts[0]; }
      const single=opts.find(o=>!o.pack); return single||opts[0];
    }

    function App(){
      const [profile,setProfile]=useState(()=>{ try{return JSON.parse(localStorage.getItem('hp_profile'))||{name:'Pool',volume:20000,sanitizer:'chlorine',surface:'plaster'};}catch(e){return {name:'Pool',volume:20000,sanitizer:'chlorine',surface:'plaster'};}});
      const [products,setProducts]=useState(()=>{ try{return JSON.parse(localStorage.getItem('hp_products'))||DEFAULT_PRODUCTS;}catch(e){return DEFAULT_PRODUCTS;}});
      const [test,setTest]=useState({FC:'',CC:'',pH:'',TA:'',CYA:'',Salt:'',Temp:''});
      const [plan,setPlan]=useState(null);
      const [shopping,setShopping]=useState([]);

      // Try remote CSV once on load (if URL present); fall back silently to defaults
      useEffect(()=>{
        if(!REMOTE_CSV) return;
        loadProductsFromCSV(REMOTE_CSV)
          .then(list=>{
            setProducts(list);
            localStorage.setItem('hp_products',JSON.stringify(list));
          })
          .catch(()=>{/* ignore; keep defaults */});
      },[]);

      useEffect(()=>{ localStorage.setItem('hp_profile',JSON.stringify(profile)); },[profile]);
      useEffect(()=>{ localStorage.setItem('hp_products',JSON.stringify(products)); },[products]);

      const parseNum=(v)=>{ const n=parseFloat(String(v).replace(/,/g,'')); return isFinite(n)?n:0; };

      function generate(){
        const V=parseNum(profile.volume), FC=parseNum(test.FC), pH=parseNum(test.pH), TA=parseNum(test.TA), CYA=parseNum(test.CYA), Salt=parseNum(test.Salt);
        const steps=[], notes=[];
        let usedAcid=false, usedChlorine=false;

        const pHTarget = 7.5;

        // Raise pH
        if(pH>0 && pH<pHTarget){
          const d = clamp(pHTarget - pH, 0, 1.5);
          const lbs = lbsSodaAshForDeltaPH(d, V);
          if(lbs>0){
            const prod=pickProduct(products,'sodaAsh');
            const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
            const cont=containersNeeded(lbs,size);
            steps.push({title:`Raise pH to ${pHTarget}`,details:`${round2(lbs)} lb soda ash (sodium carbonate)`,prod:prod,units:cont.units,usePct:cont.usePct});
            notes.push('Broadcast soda ash slowly across the deep end with pump running. Retest pH in 30–60 minutes.');
            if(lbs>5){ notes.push('Never add more than 5 lb of soda ash at a time. Split larger doses into smaller additions over ~24 hours with the pump running.'); }
          }
        }

        // Lower pH
        if(pH>0 && pH>pHTarget){
          const d=clamp(pH-pHTarget,0,1.2);
          const fl=acidFlOzForDeltaPH(d,V,TA);
          if(fl>0){
            const prod=pickProduct(products,'acid');
            const gal=roundQuarterGal(fl/128);
            const sizeGal=(prod && prod.unit==='gal'?prod.size: (prod && prod.unit==='qt'?0.25:gal));
            const cont=containersNeeded(gal,sizeGal);
            steps.push({title:`Lower pH to ${pHTarget}`,details:`about ${round2(gal)} gal 31.45% muriatic acid`,prod:prod,units:cont.units,usePct:cont.usePct});
            notes.push('With pump running, pour acid slowly in front of a return. Retest pH in 30–60 minutes.');
            usedAcid=true;
          }
        }

        // CYA
        const cyaTarget=profile.sanitizer==='swg'?70:40;
        if(CYA>0 && CYA<cyaTarget-5){
          const d=cyaTarget-CYA;
          const lbs=lbsStabilizerForCYA(d,V);
          if(lbs>0){
            const prod=pickProduct(products,'stabilizer');
            const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
            const cont=containersNeeded(lbs,size);
            steps.push({title:`Raise CYA to ${cyaTarget} ppm`,details:`${round2(lbs)} lb stabilizer (cyanuric acid)`,prod:prod,units:cont.units,usePct:cont.usePct});
            notes.push('Place in a sock in the skimmer or hang in front of a return; allow 24–48h to dissolve.');
          }
        }

        // FC — grouped options
        const fcTarget = targetFC(profile.sanitizer);
        if(FC>=0 && FC<fcTarget){
          const delta = fcTarget - FC;
          const options=[];

          if(products.some(p=>p.type==='liquidChlorine')){
            const prod=pickProduct(products,'liquidChlorine');
            const gal=roundQuarterGal(galLCForFC(delta,V));
            const size=(prod && prod.unit==='gal'?prod.size:gal+1);
            const cont=containersNeeded(gal,size);
            options.push({label:'A', title:`Liquid`, details:`about ${round2(gal)} gal liquid chlorine`, prod, units:cont.units, usePct:cont.usePct});
            usedChlorine=true;
          }

          if(profile.surface!=='vinyl' && products.some(p=>p.type==='dichlor')){
            const prod=pickProduct(products,'dichlor');
            const r=lbsDichlorForFC(delta,V);
            const size=(prod && prod.unit==='lb'?prod.size:r.lbs+1);
            const cont=containersNeeded(r.lbs,size);
            options.push({label:'B', title:`Dichlor`, details:`${round2(r.lbs)} lb dichlor (adds ~${round2(r.cyaGain)} ppm CYA)`, prod, units:cont.units, usePct:cont.usePct});
          } else if(profile.surface==='vinyl'){
            notes.push('Vinyl liners: avoid granular chlorine (dichlor/cal-hypo). Use liquid chlorine to reduce bleaching risk.');
          }

          if(options.length>0){ steps.push({type:'chlorineGroup', target:fcTarget, options}); }
        }

        // TA up if low
        const taTarget=profile.sanitizer==='swg'?70:80;
        if(TA>0 && TA<taTarget-5){
          const lbs=lbsBicarbForTA(taTarget-TA,V);
          const prod=pickProduct(products,'bicarb');
          const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
          const cont=containersNeeded(lbs,size);
          steps.push({title:`Raise TA to ${taTarget} ppm`,details:`${round2(lbs)} lb sodium bicarbonate (baking soda)`,prod:prod,units:cont.units,usePct:cont.usePct});
          notes.push('Broadcast slowly across the deep end with pump running. Retest TA in 12–24h.');
        }

        // Salt w/ bag rounding & 3800 cap
        if(profile.sanitizer==='swg' && Salt>0){
          const target=3200;
          if(Salt<target-50){
            const lbsExact = lbsSaltForDelta(target - Salt, V);
            const prod=pickProduct(products,'salt');
            const bagSize = (prod && prod.unit==='lb' && prod.size>0) ? prod.size : 40;

            let bags = Math.round(lbsExact / bagSize);
            let finalSalt = Salt + ppmFromSaltLbs(bags * bagSize, V);
            while(bags>0 && finalSalt>3800){
              bags -= 1;
              finalSalt = Salt + ppmFromSaltLbs(bags * bagSize, V);
            }
            if(bags>0){
              const lbs = bags * bagSize;
              steps.push({title:`Raise Salt to ~${Math.round(finalSalt)} ppm`,details:`${lbs} lb pool salt (~${bags} bag${bags>1?'s':''})`,prod,units:bags,usePct:100});
              notes.push('Add bags of salt slowly to the deep end, and brush to help dissolve. Wait ~24h before re-checking the cell.');
            }
          }
        }

        if(usedAcid && usedChlorine){ notes.push('Do not add chlorine and acid at the same time. Dose 30 minutes apart or at opposite ends of the pool to avoid fumes.'); }
        notes.push('Chlorine options: choose ONE (liquid or dichlor), not both.');

        // Shopping
        const shop=[];
        for(const s of steps){
          if(s.type==='chlorineGroup'){
            for(const o of s.options){
              shop.push({
                name: (o.prod && o.prod.name) ? o.prod.name : `Chlorine (${o.title})`,
                containers:o.units||1,
                size:(o.prod? (o.prod.size+' '+o.prod.unit+(o.prod.pack?(' x'+o.prod.pack):'')) : ''),
                url:(o.prod && o.prod.url)?o.prod.url:'',
                note: o.details+' (~'+(o.usePct||100)+'% of last container)'
              });
            }
          }else{
            shop.push({
              name:(s.prod && s.prod.name)?s.prod.name:s.title,
              containers:s.units||1,
              size:(s.prod? (s.prod.size+' '+s.prod.unit+(s.prod.pack?(' x'+s.prod.pack):'')) : ''),
              url:(s.prod && s.prod.url)?s.prod.url:'',
              note: s.details+' (~'+(s.usePct||100)+'% of last container)'
            });
          }
        }
        setPlan({steps,notes});
        setShopping(shop);

        const hist=JSON.parse(localStorage.getItem('hp_tests')||'[]');
        hist.unshift({at:new Date().toISOString(),profile:profile,test:test});
        while(hist.length>10) hist.pop();
        localStorage.setItem('hp_tests',JSON.stringify(hist));
      }

      return (
        <div className="hp-container">
          <div className="hp-row" style={{marginBottom:16}}>
            <div style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
              <h1 className="hp-h1">Harmony Pools — Water Test</h1>
              <button className="hp-ghost hp-btn" onClick={()=>alert('Tap your browser menu → Add to Home Screen')}>Install</button>
            </div>
          </div>

          <div className="hp-row">
            <div className="hp-card">
              <h2 className="hp-h2">Pool</h2>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                <div>
                  <label className="hp-label">Name</label>
                  <input className="hp-input" value={profile.name} onChange={e=>setProfile({...profile,name:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Volume (gallons)</label>
                  <input className="hp-input" type="number" min="1000" step="100" value={profile.volume} onChange={e=>setProfile({...profile,volume:e.target.value})} />
                  <div className="hp-tip">L×W×Avg depth × 7.5</div>
                </div>
                <div>
                  <label className="hp-label">Sanitizer</label>
                  <select className="hp-select" value={profile.sanitizer} onChange={e=>setProfile({...profile,sanitizer:e.target.value})}>
                    <option value="chlorine">Chlorine</option>
                    <option value="swg">Salt Water Generator</option>
                    <option value="bromine">Bromine</option>
                  </select>
                </div>
                <div>
                  <label className="hp-label">Surface</label>
                  <select className="hp-select" value={profile.surface} onChange={e=>setProfile({...profile,surface:e.target.value})}>
                    <option value="vinyl">Vinyl</option>
                    <option value="plaster">Plaster</option>
                    <option value="fiberglass">Fiberglass</option>
                  </select>
                </div>
              </div>
            </div>

            <div className="hp-card">
              <h2 className="hp-h2">Products</h2>
              <div style={{maxHeight:170,overflow:'auto',marginTop:8}}>
                <table className="hp-table">
                  <thead><tr><th>Name</th><th>Type</th><th>Size</th><th>Strength</th><th>Link</th></tr></thead>
                  <tbody>
                    {products.map((p,i)=> (
                      <tr key={i}>
                        <td>{p.name}</td>
                        <td>{p.type}{p.pack?` (x${p.pack})`:''}</td>
                        <td>{p.size} {p.unit}</td>
                        <td>{p.pct?`${p.pct}%`:'—'}</td>
                        <td>{p.url ? <a href={p.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">View</a> : '—'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div className="hp-row" style={{marginTop:16}}>
            <div className="hp-card">
              <h2 className="hp-h2">Enter Readings</h2>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
                {['FC','CC','pH','TA','CYA','Salt'].map(key=> (
                  <div key={key}>
                    <label className="hp-label">{key}</label>
                    <input className="hp-input" type="number" step="any" value={test[key]} onChange={e=>setTest({...test,[key]:e.target.value})} />
                  </div>
                ))}
              </div>
              <div style={{marginTop:12,display:'flex',gap:8}}>
                <button className="hp-btn" onClick={generate}>Generate Plan</button>
                <button className="hp-ghost hp-btn" onClick={()=>{ setTest({FC:'',CC:'',pH:'',TA:'',CYA:'',Salt:'',Temp:''}); setPlan(null); setShopping([]); }}>Clear</button>
              </div>
            </div>

            <div className="hp-card">
              <h2 className="hp-h2">Treatment Plan</h2>
              {!plan && (<div className="hp-note">Enter readings and tap Generate.</div>)}
              {plan && (
                <div>
                  <ol style={{margin:'0 0 0 18px'}}>
                    {plan.steps.map((s,idx)=> {
                      if(s.type==='chlorineGroup'){
                        return (
                          <li key={idx} style={{marginBottom:10}}>
                            <div style={{fontWeight:600}}>
                              Raise FC to {s.target} ppm — <span style={{color:'var(--muted)'}}>choose ONE:</span>
                            </div>
                            <div className="hp-sub">
                              <div><strong>A.</strong> {s.options[0]?.title || ''} — <span className="hp-note">{s.options[0]?.details}</span></div>
                              {s.options[0]?.prod && (
                                <div className="hp-note" style={{marginLeft:18,display:'flex',gap:8,alignItems:'center'}}>
                                  <span className="hp-chip">{s.options[0].prod.name}</span>
                                  {s.options[0].prod.url ? <a href={s.options[0].prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                                  <span>Containers: {s.options[0].units} (~{s.options[0].usePct}% last one)</span>
                                </div>
                              )}
                              {s.options[1] && (
                                <>
                                  <div style={{marginTop:6}}><strong>B.</strong> {s.options[1].title} — <span className="hp-note">{s.options[1].details}</span></div>
                                  <div className="hp-note" style={{marginLeft:18,display:'flex',gap:8,alignItems:'center')}>
                                    <span className="hp-chip">{s.options[1].prod.name}</span>
                                    {s.options[1].prod.url ? <a href={s.options[1].prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                                    <span>Containers: {s.options[1].units} (~{s.options[1].usePct}% last one)</span>
                                  </div>
                                </>
                              )}
                            </div>
                          </li>
                        );
                      }
                      return (
                        <li key={idx} style={{marginBottom:10}}>
                          <div style={{fontWeight:600}}>{s.title}</div>
                          <div className="hp-note">{s.details}</div>
                          {s.prod && (
                            <div className="hp-note" style={{marginTop:4,display:'flex',gap:8,alignItems:'center'}}>
                              <span className="hp-chip">{s.prod.name}</span>
                              {s.prod.url ? <a href={s.prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                              <span>Containers: {s.units} (~{s.usePct}% last one)</span>
                            </div>
                          )}
                        </li>
                      );
                    })}
                  </ol>
                  <div className="hp-note" style={{marginTop:6}}>
                    {plan.notes.map((n,i)=>(<div key={i}>• {n}</div>))}
                    <div>Safety: Wear PPE. Add chemicals separately with pump running. Never mix.</div>
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="hp-row" style={{marginTop:16}}>
            <div className="hp-card">
              <h2 className="hp-h2">Shopping List</h2>
              {shopping.length===0 && (<div className="hp-note">Generate a plan to build your list.</div>)}
              {shopping.length>0 && (
                <div style={{overflow:'auto'}}>
                  <table className="hp-table">
                    <thead><tr><th>Product</th><th>Containers</th><th>Size</th><th>Notes</th><th>Link</th></tr></thead>
                    <tbody>
                      {shopping.map((it,i)=> (
                        <tr key={i}>
                          <td>{it.name}</td>
                          <td>{it.containers}</td>
                          <td>{it.size}</td>
                          <td>{it.note}</td>
                          <td>{it.url? <a href={it.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : '—'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </div>

          <div className="hp-note" style={{marginTop:18}}>Preview only — formulas are approximations. Retest after each step. CYA and salt may take 24–48h to reflect.</div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('hp-watertest'));
    root.render(<App/>);
  </script>
</body>
</html>
