<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harmony Pools — Water Test</title>
  <style>
    :root{ --sky:#0ea5e9; --text:#0f172a; --muted:#64748b; --bg:#f1f5f9; --warn:#9a3412; }
    *{ box-sizing:border-box; font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(#f0f9ff,#fff); color:var(--text); }
    #hp-watertest{ padding:16px; }
    .hp-container{ max-width:1100px; margin:0 auto; }
    .hp-row{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:900px){ .hp-row-2{ grid-template-columns:1fr 1fr; } }
    .hp-card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .hp-h1{ font-size:28px; font-weight:600; margin:0 0 12px; }
    .hp-h2{ font-size:18px; font-weight:600; margin:0 0 8px; }
    .hp-label{ font-size:13px; color:#334155; display:block; margin-bottom:6px; }
    .hp-input,.hp-select{ width:100%; border:1px solid #cbd5e1; border-radius:12px; padding:10px 12px; font-size:14px; }
    .hp-tip{ font-size:12px; color:#64748b; margin-top:6px; }
    .hp-btn{ background:var(--sky); color:#fff; border:0; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    .hp-btn:hover{ filter:brightness(.95); }
    .hp-ghost{ background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
    .hp-table{ width:100%; border-collapse:collapse; font-size:14px; }
    .hp-table th{ text-align:left; color:#64748b; font-weight:600; }
    .hp-table td,.hp-table th{ padding:6px 8px; border-top:1px solid #f1f5f9; }
    .hp-chip{ display:inline-flex; align-items:center; background:#f1f5f9; color:#0f172a; border-radius:999px; padding:2px 8px; font-size:12px; }
    .hp-note{ font-size:12px; color:#64748b; }
    .hp-sub{ margin:6px 0 0 12px; }
    .hp-banner{ background:#fff7ed; color:var(--warn); border:1px solid #fed7aa; border-radius:12px; padding:10px 12px; font-size:13px; }
    .hp-fixederr{ position:fixed; left:12px; right:12px; bottom:12px; z-index:9999; }
  </style>
</head>
<body>
  <div id="hp-warn" class="hp-fixederr" style="display:none;"></div>
  <div id="hp-watertest"><div style="padding:16px" class="hp-container"><div class="hp-banner">Loading…</div></div></div>

  <!-- React + ReactDOM + Babel + PapaParse -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    (function(){
      const box = document.getElementById('hp-warn');
      function show(msg){
        box.style.display='block';
        box.innerHTML = '<div class="hp-banner">'+ msg +'</div>';
      }
      window.addEventListener('error', (e)=> show('Script error: '+ (e.message||'unknown')));
      window.addEventListener('unhandledrejection', (e)=> show('Load error: '+ (e.reason&&e.reason.message ? e.reason.message : String(e.reason||'unknown'))));
      window.hpShowWarn = show;
    })();
  </script>

  <script type="text/babel" data-presets="env,react">
    const { useState, useEffect } = React;

    const REMOTE_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR1HgxbWQ441jPd-mXIQV9Hu1uQTUQztXe6wEUS870HGAdArrs9eSDUoJJBX4waWAarA7fy-m66IPIm/pub?output=csv';

    const round2=(n)=>Math.round(n*100)/100;
    const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
    const roundQuarterGal=(gal)=> gal<=0 ? 0 : Math.max(0.25, Math.round(gal*4)/4);
    const targetFC = ()=>3;

    function acidFlOzForDeltaPH(delta, gal, TA, pHstart){
      if (delta<=0) return 0;
      const base={0.2:10,0.4:20,0.6:32,0.8:46,1.0:62};
      const keys=[0.2,0.4,0.6,0.8,1.0];
      let need=62;
      for(let i=0;i<keys.length;i++){
        if(delta===keys[i]){need=base[keys[i]];break;}
        if(delta<keys[i]){
          const k1=keys[i-1]||0,k2=keys[i],v1=k1?base[k1]:0,v2=base[k2];
          need=v1+((delta-k1)/(k2-k1))*(v2-v1); break;
        }
      }
      const taFactor = 1 + Math.max(0,(TA-100))/160;
      const hiPH = pHstart>8.2 ? 1.15 : 1;
      return need*(gal/10000)*taFactor*hiPH;
    }
    function lbsSodaAshForDeltaPH(delta, gal){ if (delta<=0) return 0; const ozPer10kPer0_2 = 12; const ounces = (delta/0.2) * ozPer10kPer0_2 * (gal/10000); return ounces/16; }
    const galLCForFC = (dFC, gal)=> dFC<=0 ? 0 : (dFC/3)*(gal/10000);
    function lbsDichlorForFC(dFC, gal){ if(dFC<=0) return {lbs:0,cyaGain:0}; const lbs=(dFC/3)*(gal/10000); const cyaGain = lbs*6*(10000/gal); return {lbs,cyaGain}; }
    const lbsBicarbForTA = (dTA, gal)=> dTA<=0 ? 0 : (dTA/10)*1.4*(gal/10000);
    const lbsStabilizerForCYA = (dCYA, gal)=> dCYA<=0 ? 0 : (dCYA/10)*0.8125*(gal/10000);
    function lbsSaltForDelta(dSalt, gal){ if(dSalt<=0) return 0; return dSalt * gal * 0.00000835; }
    function ppmFromSaltLbs(lbs, gal){ if(lbs<=0) return 0; return lbs / (gal * 0.00000835); }
    function containersNeeded(amount,size){ if(!size||size<=0) return {units:0,usePct:0}; const u=Math.ceil(amount/size); const p=amount/(u*size)*100; return {units:u,usePct:Math.min(100,Math.round(p))}; }

    const DEFAULT_PRODUCTS=[
      { name:'Muriatic Acid gallon', type:'acid', size:1, unit:'gal', pct:31.45, url:'' },
      { name:'Muriatic Acid case', type:'acid', size:1, unit:'gal', pct:31.45, pack:4, url:'' },
      { name:'Liquid Chlorine case', type:'liquidChlorine', size:1, unit:'gal', pct:12.5, pack:4, url:'' },
      { name:'Soda Ash 10 lb', type:'sodaAsh', size:10, unit:'lb', url:'' },
      { name:'Bicarbonate 10 lb', type:'bicarb', size:10, unit:'lb', url:'' },
      { name:'Stabilizer 4 lb', type:'stabilizer', size:4, unit:'lb', url:'' },
      { name:'Pool Salt 40 lb', type:'salt', size:40, unit:'lb', url:'' },
      { name:'Dichlor 25 lb', type:'dichlor', size:25, unit:'lb', pct:56, url:'' },
      { name:'Oxidizer 1 lb', type:'oxidizer', size:1, unit:'lb', url:'' },
      { name:'Phosphate Remover 1 qt', type:'phosphateRemover', size:1, unit:'qt', url:'' },
    ];

    async function loadProductsFromCSV(url, timeoutMs=6000){
      const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {signal: ctrl.signal}); if(!res.ok) throw new Error('CSV fetch failed ('+res.status+')');
        const text = await res.text(); const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        if (parsed.errors && parsed.errors.length) throw new Error('CSV parse error');
        const out=[];
        for (const row of parsed.data){
          const e = Object.fromEntries(Object.entries(row).map(([k,v])=>[String(k||'').toLowerCase().trim(), String(v??'').trim()]));
          const name = e['product name'] || e['name'] || '';
          const type = e['dose type'] || e['type'] || '';
          const size = parseFloat(e['size amount'] || e['size'] || '');
          const unit = e['size unit'] || e['unit'] || '';
          const pctKey = Object.keys(e).find(k=> k.includes('strength') || k==='%' || k.includes('percent') || k.includes('available'));
          const urlKey = Object.keys(e).find(k=> k.includes('url') || k.includes('link'));
          const packKey = Object.keys(e).find(k=> k.includes('pack') || k.includes('case') || k.includes('qty'));
          const pct = pctKey ? parseFloat(e[pctKey]) : undefined;
          const url = urlKey ? e[urlKey] : '';
          const pack = packKey ? parseInt(e[packKey]) : undefined;
          if(name && type && unit && size>0){ out.push({ name, type, size, unit, pct: isFinite(pct)?pct:undefined, url, pack: isFinite(pack)?pack:undefined }); }
        }
        if(!out.length) throw new Error('No valid product rows');
        return out;
      } finally { clearTimeout(t); }
    }

    function pickProduct(products, type){
      const opts=products.filter(p=>p.type===type);
      if(!opts.length) return undefined;
      if(type==='liquidChlorine'){ const c=opts.find(o=>o.pack&&o.pack>1); return c||opts[0]; }
      const single=opts.find(o=>!o.pack); return single||opts[0];
    }

    function App(){
      const [profile,setProfile]=useState(()=>{ try{return JSON.parse(localStorage.getItem('hp_profile'))||{name:'Pool',volume:20000,sanitizer:'chlorine',surface:'plaster'};}catch(e){return {name:'Pool',volume:20000,sanitizer:'chlorine',surface:'plaster'};}});
      const [products,setProducts]=useState(()=>{ try{return JSON.parse(localStorage.getItem('hp_products'))||DEFAULT_PRODUCTS;}catch(e){return DEFAULT_PRODUCTS;}});
      const [test,setTest]=useState({FC:'',TC:'',pH:'',TA:'',CYA:'',Salt:'',Temp:''});
      const [plan,setPlan]=useState(null);
      const [banner,setBanner]=useState('');

      useEffect(()=>{ (async ()=>{
        try{ const list = await loadProductsFromCSV(REMOTE_CSV); setProducts(list); localStorage.setItem('hp_products', JSON.stringify(list)); }
        catch(e){ setBanner('Using default products (sheet not loaded yet).'); if(window.hpShowWarn) window.hpShowWarn('Products sheet fallback: '+ (e.message||e)); }
      })(); },[]);
      useEffect(()=>{ localStorage.setItem('hp_profile',JSON.stringify(profile)); },[profile]);
      useEffect(()=>{ localStorage.setItem('hp_products',JSON.stringify(products)); },[products]);

      const parseNum=(v)=>{ const n=parseFloat(String(v).replace(/,/g,'')); return isFinite(n)?n:0; };

      function generate(){
        const V=parseNum(profile.volume),
              FC=parseNum(test.FC),
              TC=parseNum(test.TC || test.CC),
              pH=parseNum(test.pH),
              TA=parseNum(test.TA),
              CYA=parseNum(test.CYA),
              Salt=parseNum(test.Salt);

        const dosingSteps=[], drainSteps=[], notes=[];
        let usedAcid=false, usedChlorine=false;
        const pHTarget = 7.5;

        // --- Drain/refill advisories FIRST ---
        if(CYA>180){
          drainSteps.push({title:'Lower CYA (too high)', details:'Drain a couple inches and refill with fresh water. Always keep water above the skimmer opening.', prod:null, units:0, usePct:0});
        }
        if(Salt>4000){
          drainSteps.push({title:'Lower Salt (too high)', details:'Drain a couple inches and refill with fresh water. Keep skimmer covered with water at all times.', prod:null, units:0, usePct:0});
        }

        // --- pH raise ---
        if(pH>0 && pH<pHTarget){
          const d = clamp(pHTarget - pH, 0, 1.5);
          const lbs = lbsSodaAshForDeltaPH(d, V);
          if(lbs>0){
            const prod=pickProduct(products,'sodaAsh');
            const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
            const cont=containersNeeded(lbs,size);
            dosingSteps.push({title:`Raise pH to ${pHTarget}`,details:`${round2(lbs)} lb soda ash (sodium carbonate)`,prod:prod,units:cont.units,usePct:cont.usePct});
            notes.push('Broadcast soda ash slowly across the deep end with pump running. Retest pH in 30–60 minutes.');
            if(lbs>5){ notes.push('Never add more than 5 lb of soda ash at a time. Split larger doses into smaller additions over ~24 hours with the pump running.'); }
          }
        }

        // --- pH lower (split dose) ---
        if(pH>0 && pH>pHTarget){
          const d=clamp(pH-pHTarget,0,1.5);
          const fl=acidFlOzForDeltaPH(d,V,TA,pH);
          if(fl>0){
            const prod=pickProduct(products,'acid');
            const totalGal = fl/128;
            const gal1 = roundQuarterGal(Math.min(totalGal, 1));
            const gal2 = roundQuarterGal(Math.max(0, totalGal - gal1));
            const sizeGal=(prod && prod.unit==='gal'?prod.size:0.25);
            const cont=containersNeeded(gal1,sizeGal);
            dosingSteps.push({title:`Lower pH to ${pHTarget}`,details:`about ${round2(gal1)} gal 31.45% muriatic acid (then retest before any remainder)`,prod:prod,units:cont.units,usePct:cont.usePct});
            if(gal2>0){
              const cont2=containersNeeded(gal2,sizeGal);
              dosingSteps.push({title:`If pH still above ${pHTarget} after retest`,details:`add ~${round2(gal2)} gal more acid`,prod:prod,units:cont2.units,usePct:cont2.usePct});
            }
            notes.push('With pump running, pour acid slowly in front of a return. Retest pH in 30–60 minutes before adding any remainder.');
            usedAcid=true;
          }
        }

        // --- Oxidizer when FC ≠ TC ---
        if(isFinite(FC) && isFinite(TC) && Math.abs(TC-FC) > 0.01){
          const lbs = round2( (V/10000) * 1 );
          const prod = pickProduct(products,'oxidizer');
          const size=(prod && prod.unit==='lb'?prod.size:1);
          const cont=containersNeeded(lbs,size);
          dosingSteps.push({title:'Oxidize (non-chlorine shock)', details:`${lbs} lb oxidizer`, prod, units:cont.units, usePct:cont.usePct});
          notes.push('Oxidizer: you can’t really “over-oxidize,” but it may nudge pH down slightly.');
        }

        // --- CYA raise if low ---
        const cyaTarget=profile.sanitizer==='swg'?70:40;
        if(CYA>0 && CYA<cyaTarget-5){
          const lbs=lbsStabilizerForCYA(cyaTarget-CYA,V);
          if(lbs>0){
            const prod=pickProduct(products,'stabilizer');
            const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
            const cont=containersNeeded(lbs,size);
            dosingSteps.push({title:`Raise CYA to ${cyaTarget} ppm`,details:`${round2(lbs)} lb stabilizer (cyanuric acid)`,prod:prod,units:cont.units,usePct:cont.usePct});
            notes.push('Place in a sock in the skimmer or hang in front of a return; allow 24–48h to dissolve.');
          }
        }

        // --- FC to 3 ppm, A/B options (no dichlor for vinyl) ---
        const fcT = targetFC();
        if(FC>=0 && FC<fcT){
          const delta = fcT - FC;
          const options=[];
          if(products.some(p=>p.type==='liquidChlorine')){
            const prod=pickProduct(products,'liquidChlorine');
            const gal=roundQuarterGal(galLCForFC(delta,V));
            const size=(prod && prod.unit==='gal'?prod.size:gal+1);
            const cont=containersNeeded(gal,size);
            options.push({label:'A', title:`Liquid`, details:`about ${round2(gal)} gal liquid chlorine`, prod, units:cont.units, usePct:cont.usePct});
            usedChlorine=true;
          }
          if(profile.surface!=='vinyl' && products.some(p=>p.type==='dichlor')){
            const prod=pickProduct(products,'dichlor');
            const r=lbsDichlorForFC(delta,V);
            const size=(prod && prod.unit==='lb'?prod.size:r.lbs+1);
            const cont=containersNeeded(r.lbs,size);
            options.push({label:'B', title:`Dichlor`, details:`${round2(r.lbs)} lb dichlor (adds ~${round2(r.cyaGain)} ppm CYA)`, prod, units:cont.units, usePct:cont.usePct});
          } else if(profile.surface==='vinyl'){
            notes.push('Vinyl liners: avoid granular chlorine (dichlor/cal-hypo). Use liquid chlorine to reduce bleaching risk.');
          }
          if(options.length>0){ dosingSteps.push({type:'chlorineGroup', target:fcT, options}); }
        }

        // --- TA raise if low ---
        const taTarget=profile.sanitizer==='swg'?70:80;
        if(TA>0 && TA<taTarget-5){
          const lbs=lbsBicarbForTA(taTarget-TA,V);
          const prod=pickProduct(products,'bicarb');
          const size=(prod && prod.unit==='lb'?prod.size:lbs+1);
          const cont=containersNeeded(lbs,size);
          dosingSteps.push({title:`Raise TA to ${taTarget} ppm`,details:`${round2(lbs)} lb sodium bicarbonate (baking soda)`,prod:prod,units:cont.units,usePct:cont.usePct});
          notes.push('Broadcast slowly across the deep end with pump running. Retest TA in 12–24h.');
        }

        // --- Salt raise (only if not capped by drain guidance) ---
        if(profile.sanitizer==='swg' && Salt>0 && Salt<3200-50){
          const lbsExact = lbsSaltForDelta(3200 - Salt, V);
          const prod=pickProduct(products,'salt');
          const bagSize = (prod && prod.unit==='lb' && prod.size>0) ? prod.size : 40;
          let bags = Math.round(lbsExact / bagSize);
          let finalSalt = Salt + ppmFromSaltLbs(bags * bagSize, V);
          while(bags>0 && finalSalt>3800){
            bags -= 1;
            finalSalt = Salt + ppmFromSaltLbs(bags * bagSize, V);
          }
          if(bags>0){
            const lbs = bags * bagSize;
            dosingSteps.push({title:`Raise Salt to ~${Math.round(finalSalt)} ppm`,details:`${lbs} lb pool salt (~${bags} bag${bags>1?'s':''})`,prod,units:bags,usePct:100});
            notes.push('Add bags of salt slowly to the deep end, and brush to help dissolve. Wait ~24h before re-checking the cell.');
          }
        }

        if(usedAcid && usedChlorine){ notes.push('Do not add chlorine and acid at the same time. Dose 30 minutes apart or at opposite ends of the pool to avoid fumes.'); }
        notes.push('Chlorine options: choose ONE (liquid or dichlor), not both.');

        // Final step order: drain/refill first, then dosing
        const steps=[...drainSteps, ...dosingSteps];
        setPlan({steps,notes});
      }

      return (
        <div className="hp-container">
          {banner && <div className="hp-banner" style={{marginBottom:12}}>{banner}</div>}

          {/* Row 1: Pool only */}
          <div className="hp-row">
            <div className="hp-card">
              <h2 className="hp-h2">Pool</h2>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                <div>
                  <label className="hp-label">Name</label>
                  <input className="hp-input" value={profile.name} onChange={e=>setProfile({...profile,name:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Volume (gallons)</label>
                  <input className="hp-input" type="number" min="1000" step="100" value={profile.volume} onChange={e=>setProfile({...profile,volume:e.target.value})} />
                  <div className="hp-tip">L×W×Avg depth × 7.5</div>
                </div>
                <div>
                  <label className="hp-label">Sanitizer</label>
                  <select className="hp-select" value={profile.sanitizer} onChange={e=>setProfile({...profile,sanitizer:e.target.value})}>
                    <option value="chlorine">Chlorine</option>
                    <option value="swg">Salt Water Generator</option>
                    <option value="bromine">Bromine</option>
                  </select>
                </div>
                <div>
                  <label className="hp-label">Surface</label>
                  <select className="hp-select" value={profile.surface} onChange={e=>setProfile({...profile,surface:e.target.value})}>
                    <option value="vinyl">Vinyl</option>
                    <option value="plaster">Plaster</option>
                    <option value="fiberglass">Fiberglass</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          {/* Row 2: Enter Readings + Treatment Plan */}
          <div className="hp-row hp-row-2" style={{marginTop:16}}>
            <div className="hp-card">
              <h2 className="hp-h2">Enter Readings</h2>
              <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:12}}>
                <div>
                  <label className="hp-label">Free Chlorine (FC)</label>
                  <input className="hp-input" type="number" step="any" value={test.FC} onChange={e=>setTest({...test,FC:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Total Chlorine (TC)</label>
                  <input className="hp-input" type="number" step="any" value={test.TC} onChange={e=>setTest({...test,TC:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">pH</label>
                  <input className="hp-input" type="number" step="any" value={test.pH} onChange={e=>setTest({...test,pH:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Total Alkalinity (TA)</label>
                  <input className="hp-input" type="number" step="any" value={test.TA} onChange={e=>setTest({...test,TA:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Cyanuric Acid (CYA)</label>
                  <input className="hp-input" type="number" step="any" value={test.CYA} onChange={e=>setTest({...test,CYA:e.target.value})} />
                </div>
                <div>
                  <label className="hp-label">Salt (ppm)</label>
                  <input className="hp-input" type="number" step="any" value={test.Salt} onChange={e=>setTest({...test,Salt:e.target.value})} />
                </div>
              </div>
              <div style={{marginTop:12,display:'flex',gap:8}}>
                <button className="hp-btn" onClick={generate}>Generate Plan</button>
                <button className="hp-ghost hp-btn" onClick={()=>{ setTest({FC:'',TC:'',pH:'',TA:'',CYA:'',Salt:'',Temp:''}); setPlan(null); }}>Clear</button>
              </div>
            </div>

            <div className="hp-card">
              <h2 className="hp-h2">Treatment Plan</h2>
              {!plan && <div className="hp-note">Enter readings and tap Generate.</div>}
              {plan && (
                <div>
                  <ol style={{margin:'0 0 0 18px'}}>
                    {plan.steps.map((s,idx)=>{
                      if(s.type==='chlorineGroup'){
                        return (
                          <li key={idx} style={{marginBottom:10}}>
                            <div style={{fontWeight:600}}>
                              Raise FC to {s.target} ppm — <span style={{color:'var(--muted)'}}>choose ONE:</span>
                            </div>
                            <div className="hp-sub">
                              <div><strong>A.</strong> {s.options[0]?.title} — <span className="hp-note">{s.options[0]?.details}</span></div>
                              {s.options[0]?.prod && (
                                <div className="hp-note" style={{marginLeft:18,display:'flex',gap:8,alignItems:'center'}}>
                                  <span className="hp-chip">{s.options[0].prod.name}</span>
                                  {s.options[0].prod.url ? <a href={s.options[0].prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                                  <span>Containers: {s.options[0].units} (~{s.options[0].usePct}% last one)</span>
                                </div>
                              )}
                              {s.options[1] && (
                                <>
                                  <div style={{marginTop:6}}><strong>B.</strong> {s.options[1].title} — <span className="hp-note">{s.options[1].details}</span></div>
                                  <div className="hp-note" style={{marginLeft:18,display:'flex',gap:8,alignItems:'center'}}>
                                    <span className="hp-chip">{s.options[1].prod.name}</span>
                                    {s.options[1].prod.url ? <a href={s.options[1].prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                                    <span>Containers: {s.options[1].units} (~{s.options[1].usePct}% last one)</span>
                                  </div>
                                </>
                              )}
                            </div>
                          </li>
                        );
                      }
                      return (
                        <li key={idx} style={{marginBottom:10}}>
                          <div style={{fontWeight:600}}>{s.title}</div>
                          <div className="hp-note">{s.details}</div>
                          {s.prod && (
                            <div className="hp-note" style={{marginTop:4,display:'flex',gap:8,alignItems:'center'}}>
                              <span className="hp-chip">{s.prod.name}</span>
                              {s.prod.url ? <a href={s.prod.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">Buy</a> : <span style={{color:'#94a3b8'}}>—</span>}
                              <span>Containers: {s.units} {s.usePct?`(~${s.usePct}% last one)`:''}</span>
                            </div>
                          )}
                        </li>
                      );
                    })}
                  </ol>
                  <div className="hp-note" style={{marginTop:6}}>
                    {plan.notes.map((n,i)=><div key={i}>• {n}</div>)}
                    <div>Safety: Wear PPE. Add chemicals separately with pump running. Never mix.</div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Row 3: Products LAST */}
          <div className="hp-row" style={{marginTop:16}}>
            <div className="hp-card">
              <h2 className="hp-h2">Products</h2>
              <div style={{maxHeight:170,overflow:'auto',marginTop:8}}>
                <table className="hp-table">
                  <thead><tr><th>Name</th><th>Type</th><th>Size</th><th>Strength</th><th>Link</th></tr></thead>
                  <tbody>
                    {products.map((p,i)=>(
                      <tr key={i}>
                        <td>{p.name}</td>
                        <td>{p.type}{p.pack?` (x${p.pack})`:''}</td>
                        <td>{p.size} {p.unit}</td>
                        <td>{p.pct?`${p.pct}%`:'—'}</td>
                        <td>{p.url ? <a href={p.url} target="_blank" style={{color:'var(--sky)',textDecoration:'underline'}} rel="noreferrer">View</a> : '—'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      );
    }

    try{
      const root = ReactDOM.createRoot(document.getElementById('hp-watertest'));
      root.render(<App/>);
    }catch(e){
      if(window.hpShowWarn) window.hpShowWarn('App failed to start: '+ (e.message||e));
      throw e;
    }
  </script>
</body>
</html>
